<!-- HTML header for doxygen 1.8.6-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>fplutil: android_ndk_perf</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="https://fonts.googleapis.com/css?family=Roboto:300,400,400italic,500,500italic,700,700italic|Roboto+Mono:400,700" rel="stylesheet">
<link href="style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="commonprojectlogo">
    <img alt="Logo" src="fpl_logo_small.png"/>
  </td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">fplutil
   </div>
   <div style="font-size:12px;">
	 An open source project by
     <a href="https://developers.google.com/games/#Tools">FPL</a>.
  </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li class="current"><a href="fplutil_prerequisites.html"><span>Prerequisites</span></a></li>
      <li><a href="libfplutil_overview.html"><span>libfplutil</span></a></li>
      <li><a href="android_ndk_perf.html"><span>android_ndk_perf.py</span></a></li>
      <li><a href="build_all_android.html"><span>build_all_android.py</span></a></li>
      <li><a href="buildutil_overview.html"><span>buildutil</span></a></li>
      <li><a href="md_readme.html#fplutil_readme"><span>readme</span></a></li>
      <li><a href="contributing.html"><span>contributing</span></a></li>
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('android_ndk_perf.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">android_ndk_perf </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="el" href="android_ndk_perf.html">android_ndk_perf</a> is a desktop tool that enables native (C/C++) developers to measure the CPU utilization of their applications on <a href="http://www.android.com">Android</a>, guiding their optimization efforts.</p>
<p><a class="el" href="android_ndk_perf.html">android_ndk_perf</a> uses <a href="http://perf.wiki.kernel.org">Linux Perf</a> to profile the native (C/C++) components of applications on Android. <a class="el" href="android_ndk_perf.html">android_ndk_perf</a> can be run on developer's workstations to collect traces of applications running on Android devices. After application traces are collected the data can be examined using <a href="http://perf.wiki.kernel.org">Linux Perf</a>'s commands or a HTML visualization can be generated for inspection in a web browser.</p>
<p>Examples in the following sections reference the <a href="http://google.github.io/liquidfun/">LiquidFun</a> Testbed application as it's moderately complex and provides interesting traces.</p>
<p>In order to use this tool, all <a class="el" href="fplutil_prerequisites.html">prerequisites</a> should be installed.</p>
<p><b>NOTE:</b> At the moment perfhost binaries are only provided for Linux and OSX. Windows is not yet supported!</p>
<h1><a class="anchor" id="android_ndk_perf_sampling"></a>
Sampling vs. Intrusive Profiling</h1>
<p><a href="http://perf.wiki.kernel.org">Linux Perf</a> is a sampling profiler that by default will sample the location of the instruction pointer at 1KHz. The tool can be used to configure the perf events subsystem in the Linux kernel to sample a wide variety of counters in the system.</p>
<p>Sampling profilers like <a href="http://perf.wiki.kernel.org">Linux Perf</a> are very good at providing a broad overview of application performance with very low overhead. <a href="http://perf.wiki.kernel.org">Linux Perf</a> is a great tool to determine where time is being spent in an application over a relatively long period of time (e.g seconds).</p>
<p>By constrast, intrusive profilers - where an application is instrumented with timing code - can be more effective at very quickly and accurately determining the overhead of small functions in an application. For example, when optimizing a small function it may be quicker to use an intrusive profiler to measure the number of cycles, cache misses, branch mispredicts etc. in a section of code rather than running the function over a long period of time with a high frequency sampling profiler like <a href="http://perf.wiki.kernel.org">Linux Perf</a>.</p>
<h1><a class="anchor" id="android_ndk_perf_building"></a>
Building Applications for Profiling</h1>
<p>Application to be profiled must be:</p>
<ul>
<li>Built as <a href="http://developer.android.com/guide/topics/manifest/application-element.html#debug">debuggable APK</a> (It's still possible to package release executables in a debuggable APK).</li>
<li>Compiled with symbols making it possible to convert instruction pointers in stack traces to function names.</li>
<li>If the target ABI is ARM the application should be compiled with the <code>-mapcs-frame</code> <a href="http://gcc.gnu.org/onlinedocs/gcc/ARM-Options.html">option</a> so that stack frames are compliant with the ARM Procedure Call Standard. This makes it possible for <a href="http://perf.wiki.kernel.org">Linux Perf</a> to correctly add symbolic function names to instruction pointers in traces.</li>
</ul>
<h2><a class="anchor" id="android_ndk_perf_building_fplutil"></a>
Building and Installing using build_all_android</h2>
<p>If you're building using fplutil's <a class="el" href="build_all_android.html">build_all_android</a>, the process of building and installing <a href="http://google.github.io/liquidfun/">LiquidFun</a>'s Testbed application with symbols for ARM (v7a) can be performed using the following command:</p>
<div class="fragment"><div class="line">cd liquidfun/Box2D/Testbed</div>
<div class="line">build_all_android -E dependencies -f <span class="stringliteral">&#39;NDK_DEBUG=0 APP_ABI=armeabi-v7a APP_CFLAGS=-mapcs-frame&#39;</span> -T debug -i</div>
</div><!-- fragment --><h2><a class="anchor" id="android_ndk_perf_building_manual"></a>
Building using ndk-build and ant</h2>
<p><code>ndk-build</code> can be used to build <a href="http://google.github.io/liquidfun/">LiquidFun</a> Testbed application with symbols for ARM (v7a) with the following commands:</p>
<div class="fragment"><div class="line">cd liquidfun/Box2D/Testbed</div>
<div class="line">ndk-build NDK_DEBUG=0 APP_ABI=armeabi-v7a APP_CFLAGS=-mapcs-frame</div>
</div><!-- fragment --><p>After building the application's native components it needs to be packaged in a <a href="http://developer.android.com/guide/topics/manifest/application-element.html#debug">debuggable APK</a>:</p>
<div class="fragment"><div class="line">cd liquidfun/Box2D/Testbed</div>
<div class="line">android update project --target android-15 -n testbed --path .</div>
<div class="line">ant debug</div>
</div><!-- fragment --><p>Finally, the application should be installed on a test device:</p>
<div class="fragment"><div class="line">cd liquidfun/Box2D/Testbed</div>
<div class="line">adb install bin/testbed-debug.apk</div>
</div><!-- fragment --><h1><a class="anchor" id="android_ndk_perf_record"></a>
Capturing a Trace</h1>
<p>After installing an application on a device, it's possible to capture a trace to the directory <code>output/perf.data</code> using <a class="el" href="android_ndk_perf.html">android_ndk_perf</a>'s <code>record</code> command:</p>
<div class="fragment"><div class="line">cd liquidfun/Box2D/Testbed</div>
<div class="line">android_ndk_perf --apk bin/testbed-debug.apk record -o output/perf.data</div>
</div><!-- fragment --><p>To stop the trace press <code>Ctrl-C</code> (sends the interrupt signal to the process).</p>
<p>The <code>record</code> command performs the following:</p>
<ul>
<li>Launches the main intent of the package specified by the <code>bin/testbed-debug.apk</code>.</li>
<li>Starts <a href="http://perf.wiki.kernel.org">Linux Perf</a> on the device.</li>
<li>Ctrl-C stops <a href="http://perf.wiki.kernel.org">Linux Perf</a> and the application.</li>
<li>Copies the trace from the device to <code>output/perf.data</code></li>
<li>Copies objects referenced from the device to the <code>output/</code> directory.</li>
</ul>
<h1><a class="anchor" id="android_ndk_perf_visualize"></a>
Visualizing a Trace</h1>
<p><a class="el" href="android_ndk_perf.html">android_ndk_perf</a>'s <code>visualize</code> command can be used to generate a HTML report and open the report in a web browser. The trace <code>output/perf.data</code> captured using the <code>record</code> command can be converted to the HTML report <code>report.html</code> and viewed using the following command:</p>
<div class="fragment"><div class="line">cd liquidfun/Box2D/Testbed</div>
<div class="line">android_ndk_perf visualize -i output/perf.data -o report.html</div>
</div><!-- fragment --><p>Which generates a <a href="report.html">report</a> like the following: </p>
<div class="image">
<img src="android_ndk_perf_visualize.png"  alt="Visualizer Report" style="width: 80%"/>
</div>
<p>The multi-colored box on the left is a legend that very roughly classifies a subset of objects profiled:</p>
<div class="image">
<img src="android_ndk_perf_visualize_legend.png"  alt="Visualizer Legend" style="height: 20em;"/>
</div>
<p>The center of the <a href="report.html">report</a> is populated by a chart which contains concentric rings where each ring represents a level of the stack from the entry point of the application at the center out to the leaf functions on the outside of the chart. The top number in the center of the chart describes the total time used by the function highlighted by the mouse pointer on the chart. The lower number provides the percentage of the time the function was called for over the profiling period.</p>
<div class="image">
<img src="android_ndk_perf_visualize_chart.png"  alt="Visualizer Chart" style="width: 80%"/>
</div>
<p>When a ring is highlighted in the chart, the stack trace of visible functions in the chart are shown on the top right side of the screen:</p>
<div class="image">
<img src="android_ndk_perf_visualize_summary.png"  alt="Visualizer Stack Summary" style="width: 80%"/>
</div>
<p>Finally, the stack for the currently selected function is shown along with the percent of time spent in each function on the bottom left of the screen:</p>
<div class="image">
<img src="android_ndk_perf_visualize_details.png"  alt="Visualizer Stack Details" style="width: 80%"/>
</div>
<p>An example <a href="report.html">report</a> generated from a profile of <a href="http://google.github.io/liquidfun/">LiquidFun</a>'s Testbed application, captured on a Nexus 5, is available to browse <a href="report.html">here</a>.</p>
<h1><a class="anchor" id="android_ndk_perf_report"></a>
Trace Reports</h1>
<p><a href="http://perf.wiki.kernel.org">Linux Perf</a> provides the <code>report</code> command to view a <code>perf.data</code> trace file. This command can be invoked via <a class="el" href="android_ndk_perf.html">android_ndk_perf</a> using the following:</p>
<div class="fragment"><div class="line">cd liquidfun/Box2D/Testbed</div>
<div class="line">android_ndk_perf report -i output/perf.data</div>
</div><!-- fragment --><p><code>report</code> provides a view similar to the <code>visualize</code> command's output with a tree view showing a call graph hierarchy and the percentage of time spent in each function down the graph.</p>
<p>A more terse overview of the data can be retrieved using:</p>
<div class="fragment"><div class="line">cd liquidfun/Box2D/Testbed</div>
<div class="line">android_ndk_perf report -i output/perf.data --call-graph none</div>
</div><!-- fragment --><p>Which will produce something like the following, summarizing the amount of time spent in each function over the profiling period: </p>
<div class="fragment"><div class="line"><span class="preprocessor"># Events: 4K cpu-clock</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor"># Overhead  Command     Shared Object           Symbol</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor"># ........  ..........  ......................  ......</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#</span></div>
<div class="line"><span class="preprocessor"></span>    13.42%  GL updater  libqdutils.so           [.] 0xc03a8 </div>
<div class="line">     3.67%  GL updater  libqdutils.so           [.] b2ParticleSystem::InsideBoundsEnumerator::GetNext()</div>
<div class="line">     3.22%  GL updater  libqdutils.so           [.] 0x5fe00 </div>
<div class="line">     2.77%  GL updater  libqdutils.so           [.] 0x12f24 </div>
<div class="line">     2.64%  GL updater  libqdutils.so           [.] b2PolygonShape::ComputeDistance(b2Transform <span class="keyword">const</span>&amp;, b2Vec2 <span class="keyword">const</span>&amp;, <span class="keywordtype">float</span>*, b2Vec2*, <span class="keywordtype">int</span>) const</div>
</div><!-- fragment --><p><br/>
 </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- Google Analytics -->
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-49880327-7', 'google.github.io');
ga('send', 'pageview');
</script>
</body>
</html>
